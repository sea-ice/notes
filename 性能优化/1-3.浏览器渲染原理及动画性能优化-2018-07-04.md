## 浅谈前端动画性能优化

在很多的场景下，我们常常会使用动画引入网页动态效果，从而提升用户体验。而动画的执行性能在很大程度上也决定了用户与页面发生交互时的流畅程度。接下来主要总结一下在优化页面上的动画时所涉及到的一些原理和方法。

## 浏览器如何渲染页面

说到页面性能优化，自然是和浏览器渲染页面的过程分不开的。浏览器在加载渲染页面时的过程大致如下：

- **解析**。渲染引擎首先会解析从网络上加载回来的页面上面包含的内容，包括HTML以及页面引入的其他资源如CSS、JavaScript脚本。在这个过程中，引入的CSS样式是被**异步加载和解析**的，而在遇到需要加载JavaScript脚本文件时，则会停止对页面的解析，直到JavaScript脚本加载并执行完成才会继续往下解析页面的剩余内容。解析完成之后就会得到一棵DOM树和结构与之相似的CSS规则树🌲。

- **计算布局**。根据CSS规则树上的规则对DOM树上的节点作用结果，计算各个节点在网页中显示的大小和位置以及层叠关系等等。

- **绘制**。绘制过程指的是将每个合成层中包含的可见元素的内容绘制到该合成层中（具体哪些节点可以创建合成层参照下面列出的规则👇）。具体到合成层中元素的绘制，绘制方式又分为两种，一种是软件绘图，指的是绘图操作是在CPU中完成的。软件绘图只能绘制2D方面的内容，在大多数情况下，即页面不包含具有CSS 3D 属性、CSS 3D 变换、拥有 WebGL 上下文等的这些元素时，WebKit可以直接使用软件渲染技术来完成页面的绘制工作。另一种则是GPU硬件加速绘图，顾名思义，该绘图操作是发生在GPU中的。

- **合成**。浏览器中的合成器将绘制好的各个合成层进行合并，输出最终展示在我们眼前的网页👀。

那么，页面上的哪些节点会创建新的合成层呢？创建合成层的元素节点需要满足以下条件之一：

- 该节点具有 CSS 3D 属性或者透视效果（设置了 perspective 属性）；

- 该节点设置了 opacity 透明属性或者 transform 变换属性；

- 该节点为使用了加速视频解码的 video 元素；

- 该节点为拥有 3D (WebGL) 上下文或加速的 2D 上下文的 canvas 元素；

- 该节点包含了一个创建了新的合成层的子元素，且该节点的 z-index 属性值大于该子元素的 z-index 值；

如果某个节点并没有创建合成层，则该元素节点处于其父元素所创建的合成层中。

在动画的执行过程中，浏览器会不断发生重绘（repaint）操作。而重绘的过程又会反复进行上面提到的“**计算布局**--**绘制**--**合成**”这三个阶段。相比于计算布局和绘制这两个操作，合成操作所需要的时间消耗要少得多。因此**应该尽可能地减少费时的重绘操作，或者只进行仅有合成过程的重绘**。

## 具体优化手段

有了前面的理论基础，我们试着从最后得出的结论出发，来看看具体的优化方法都有哪些。

### canvas分层

对于在一些页面元素动画需要频繁更新的场景中，比如 H5 游戏画面，可以考虑将多个需要更新的元素绘制在不同的 canvas 元素中，然后对这些 canvas 元素设置透明背景并叠加到一起，就可以创建出多个不同的合成层，这样仅需要对变化的部分对应的合成层进行更新，避免了将整个页面又重绘了一遍。

### 通过CSS 3D属性实现动画

## 参考资料

1.[酷壳·浏览器的渲染原理简介](https://coolshell.cn/articles/9666.html)
2.[凹凸实验室·GPU加速是什么](https://aotu.io/notes/2017/04/11/GPU/)
3.[伯乐在线·无线页面动画优化实例](http://web.jobbole.com/85897/)